package com.experiment.weather.presentation.ui

import androidx.compose.animation.*
import androidx.compose.animation.core.tween
import androidx.compose.animation.core.updateTransition
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.*
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Delete
import androidx.compose.material.icons.filled.Favorite
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.Color.Companion.Red
import androidx.compose.ui.graphics.Color.Companion.Transparent
import androidx.compose.ui.hapticfeedback.HapticFeedbackType
import androidx.compose.ui.platform.LocalHapticFeedback
import androidx.compose.ui.platform.LocalView
import androidx.compose.ui.unit.dp
import com.weather.core.design.theme.Yellow

@ExperimentalFoundationApi
@OptIn(ExperimentalMaterialApi::class)
@Composable
fun CustomSwipeDismiss(
    modifier: Modifier = Modifier,
    dismissThreshold: Float,
    onDeleteItem: () -> Unit,
    content: @Composable () -> Unit,
) = BoxWithConstraints(modifier = modifier) {
    val height = maxHeight.value
    val width = maxWidth.value
    val hapticFeedback = LocalHapticFeedback.current
    val localView = LocalView.current
    var allowedToDismissDirection: DismissDirection? by remember {
        mutableStateOf(null)
    }
    val dismissState = rememberDismissState(
        confirmStateChange = { dismissValue ->
            when {
                dismissValue == DismissValue.DismissedToStart &&
                        allowedToDismissDirection == DismissDirection.EndToStart -> {
                    onDeleteItem()
                    true
                }
                dismissValue == DismissValue.DismissedToEnd &&
                        allowedToDismissDirection == DismissDirection.StartToEnd -> {
                    false
                }
                else -> false
            }
        }
    )
    LaunchedEffect(key1 = Unit) {
        snapshotFlow { dismissState.offset.value }
            .collect() {
                allowedToDismissDirection = when {
                    it > (width * dismissThreshold) * 2.5 -> {
                        DismissDirection.StartToEnd
                    }
                    it < (width * -dismissThreshold) * 2.5 -> {
                        DismissDirection.EndToStart
                    }
                    else -> null
                }
            }
    }
    LaunchedEffect(key1 = allowedToDismissDirection) {
        allowedToDismissDirection?.let {
            hapticFeedback.performHapticFeedback(HapticFeedbackType.TextHandleMove)
//      localView.performHapticFeedback(HapticFeedbackConstants.KEYBOARD_TAP)
        }
    }
    SwipeToDismiss(
        state = dismissState,
        modifier = Modifier,
        directions = setOf(DismissDirection.EndToStart, DismissDirection.StartToEnd),
        dismissThresholds = { dismissDirection ->
            FractionalThreshold(
                if (dismissDirection == DismissDirection.EndToStart) dismissThreshold else .5f
            )
        },
        background = {
            DismissBackground(dismissState, allowedToDismissDirection)
        }
    ) {
        content()
    }
}

@OptIn(ExperimentalMaterialApi::class, ExperimentalAnimationApi::class)
@Composable
fun DismissBackground(
    state: DismissState,
    allowedToDismissDirection: DismissDirection?,
) = BoxWithConstraints(modifier = Modifier) {
    val canDismiss by remember {
        mutableStateOf(allowedToDismissDirection)
    }
    val direction by remember {
        mutableStateOf(state.dismissDirection)
    }
    val transition = updateTransition(targetState = canDismiss, label = "Dismiss Transition")
    val backGroundColor by animateColorAsState(
        targetValue =
        when (canDismiss) {
            DismissDirection.StartToEnd -> Yellow
            DismissDirection.EndToStart -> Red
            null -> MaterialTheme.colors.background
        }
    )
    AnimatedContent(
        targetState = Pair(state.dismissDirection, allowedToDismissDirection != null),
        transitionSpec = {
            fadeIn(
                tween(0)
            ) with fadeOut(
                tween(0)
            )
        }
    ) { (direction, allowedDismiss) ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .clip(RoundedCornerShape(16.dp))
                .background(
                    when (direction) {
                        DismissDirection.StartToEnd -> Yellow
                        DismissDirection.EndToStart -> Red
                        else -> Transparent
                    }
                )
        ) {
            Box(
                modifier = Modifier
                    .fillMaxSize().padding(horizontal = 16.dp                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ),
                contentAlignment = when (direction) {
                    DismissDirection.StartToEnd -> Alignment.CenterStart
                    else -> Alignment.CenterEnd
                }
            ) {
                when (direction) {
                    DismissDirection.EndToStart -> {
                        Icon(
                            imageVector = Icons.Default.Delete,
                            modifier = Modifier,
                            contentDescription = "delete Icon"
                        )
                    }
                    DismissDirection.StartToEnd -> {
                        Icon(
                            imageVector = Icons.Default.Favorite,
                            modifier = Modifier,
                            contentDescription = "delete Icon"
                        )
                    }
                    null -> Spacer(modifier = Modifier.width(0.dp))
                }

            }


        }
    }


}
